# .github/workflows/pages.yml
# Deploy an Angular SPA to GitHub Pages (static HTTPS) – includes SPA fallback

name: Deploy static content to Pages

on:
  push:
    branches: ["main"]          # <-- adjust if you use a different default branch
  workflow_dispatch:           # allow manual runs

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      # ---------------------------------------------------------
      # 1️⃣ Checkout the repository
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2️⃣ Set up Node (LTS version)
      # ---------------------------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # ---------------------------------------------------------
      # 3️⃣ Install dependencies (clean install)
      # ---------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # ---------------------------------------------------------
      # 4️⃣ Build Angular with the correct base‑href
      # ---------------------------------------------------------
      - name: Build Angular app
        env:
          # Resolve the repo name (e.g. "countdown-app") – this is the sub‑path
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          echo "Building for repo: $REPO_NAME"
          npx ng build --configuration production --base-href "/${REPO_NAME}/"

      # ---------------------------------------------------------
      # 5️⃣ Prepare SPA fallback (copy index.html → 404.html)
      # ---------------------------------------------------------
      - name: Add SPA fallback & .nojekyll
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          BUILD_DIR="./dist/${REPO_NAME}"
          # 5a – copy index.html to 404.html (fallback for any route)
          cp "${BUILD_DIR}/index.html" "${BUILD_DIR}/404.html"
          # 5b – create .nojekyll to disable Jekyll processing
          touch "${BUILD_DIR}/.nojekyll"

      # ---------------------------------------------------------
      # 6️⃣ Configure Pages (creates the artifact folder)
      # ---------------------------------------------------------
      - name: Setup Pages
        uses: actions/configure-pages@v5

      # ---------------------------------------------------------
      # 7️⃣ Upload the built folder as the Pages artifact
      # ---------------------------------------------------------
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Path to the folder that now contains index.html, 404.html, .nojekyll, assets…
          path: ./dist/${{ github.event.repository.name }}/

      # ---------------------------------------------------------
      # 8️⃣ Deploy to GitHub Pages (writes to gh‑pages branch)
      # ---------------------------------------------------------
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
